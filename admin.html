<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Sistema de Controle de Clientes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        header {
            background-color: #c06;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 40px;
            margin-right: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #666;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 23%;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #c06;
        }
        
        .stat-card p {
            color: #666;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid #c06;
            color: #c06;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filters {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            width: 30%;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }
        
        .filter-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-buttons {
            display: flex;
            align-items: flex-end;
        }
        
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }
        
        .clear-btn {
            background-color: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }
        
        .apply-btn {
            background-color: #c06;
            color: white;
        }
        
        .export-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f5f5f5;
            font-weight: bold;
            color: #333;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .view-details-btn {
            background-color: #007BFF;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 70%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .detail-label {
            width: 30%;
            font-weight: bold;
            color: #666;
        }
        
        .detail-value {
            width: 70%;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                flex-wrap: wrap;
            }
            
            .stat-card {
                width: 48%;
                margin-bottom: 15px;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
                margin-bottom: 15px;
            }
            
            .filter-buttons {
                justify-content: space-between;
            }
            
            button {
                margin: 0 5px;
            }
            
            .modal-content {
                width: 90%;
                margin: 20% auto;
            }
        }
        
        @media (max-width: 480px) {
            .stat-card {
                width: 100%;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                width: 50%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="Masmu-negativa.png" alt="Logo">
            <h1>Sistema de Controle de Clientes</h1>
        </div>
        <div>
            <span>Administração</span>
        </div>
    </header>
    
    <div class="container">
        <h1>Painel Administrativo</h1>
        <h2>Bem-vindo ao painel administrativo do Sistema de Controle de Clientes.</h2>
        
        <div class="stats-container">
            <div class="stat-card">
                <h3 id="totalClients">0</h3>
                <p>Total de Clientes</p>
                <small>Clientes atendidos</small>
            </div>
            <div class="stat-card">
                <h3 id="totalSales">0</h3>
                <p>Total de Vendas</p>
                <small>Vendas concluídas</small>
            </div>
            <div class="stat-card">
                <h3 id="totalValue">R$ 0,00</h3>
                <p>Valor Total</p>
                <small>Em vendas</small>
            </div>
            <div class="stat-card">
                <h3 id="averageTicket">R$ 0,00</h3>
                <p>Ticket Médio</p>
                <small>Por venda</small>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="recent">Últimos Atendimentos</div>
            <div class="tab" data-tab="clients">Clientes</div>
            <div class="tab" data-tab="sales">Vendas</div>
            <div class="tab" data-tab="attendants">Atendentes</div>
        </div>
        
        <div class="tab-content active" id="recent-tab">
            <div class="filters">
                <div class="filter-group">
                    <label for="periodFilter">Período</label>
                    <select id="periodFilter">
                        <option value="today" selected>Hoje</option>
                        <option value="yesterday">Ontem</option>
                        <option value="week">Últimos 7 dias</option>
                        <option value="month">Últimos 30 dias</option>
                        <option value="all">Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sectorFilter">Setor</label>
                    <select id="sectorFilter">
                        <option value="all" selected>Todos</option>
                        <option value="loja_fisica">Loja Física</option>
                        <option value="whatsapp_instagram">WhatsApp/Instagram</option>
                        <option value="caixa">Caixa</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="attendantFilter">Atendente</label>
                    <select id="attendantFilter">
                        <option value="all" selected>Todos</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button class="clear-btn" id="clearFilters">Limpar Filtros</button>
                    <button class="apply-btn" id="applyFilters">Aplicar Filtros</button>
                    <button class="export-btn" id="exportData">Exportar Dados</button>
                </div>
            </div>
            
            <h2>Últimos Atendimentos</h2>
            <table>
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Cliente</th>
                        <th>Atendente</th>
                        <th>Setor</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="recentAttendancesTable">
                    <tr>
                        <td colspan="7" style="text-align: center;">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="tab-content" id="clients-tab">
            <div class="filters">
                <div class="filter-group">
                    <label for="clientPeriodFilter">Período</label>
                    <select id="clientPeriodFilter">
                        <option value="today">Hoje</option>
                        <option value="yesterday">Ontem</option>
                        <option value="week">Últimos 7 dias</option>
                        <option value="month">Últimos 30 dias</option>
                        <option value="all" selected>Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="clientSectorFilter">Setor</label>
                    <select id="clientSectorFilter">
                        <option value="all" selected>Todos</option>
                        <option value="loja_fisica">Loja Física</option>
                        <option value="whatsapp_instagram">WhatsApp/Instagram</option>
                        <option value="caixa">Caixa</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="clientSearchFilter">Buscar Cliente</label>
                    <input type="text" id="clientSearchFilter" placeholder="Nome do cliente">
                </div>
                <div class="filter-buttons">
                    <button class="clear-btn" id="clearClientFilters">Limpar Filtros</button>
                    <button class="apply-btn" id="applyClientFilters">Aplicar Filtros</button>
                    <button class="export-btn" id="exportClientData">Exportar Dados</button>
                </div>
            </div>
            
            <h2>Clientes</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Contato</th>
                        <th>Atendimentos</th>
                        <th>Compras</th>
                        <th>Valor Total</th>
                        <th>Último Atendimento</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="clientsTable">
                    <tr>
                        <td colspan="7" style="text-align: center;">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="tab-content" id="sales-tab">
            <div class="filters">
                <div class="filter-group">
                    <label for="salePeriodFilter">Período</label>
                    <select id="salePeriodFilter">
                        <option value="today">Hoje</option>
                        <option value="yesterday">Ontem</option>
                        <option value="week">Últimos 7 dias</option>
                        <option value="month">Últimos 30 dias</option>
                        <option value="all" selected>Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="saleSectorFilter">Setor</label>
                    <select id="saleSectorFilter">
                        <option value="all" selected>Todos</option>
                        <option value="loja_fisica">Loja Física</option>
                        <option value="whatsapp_instagram">WhatsApp/Instagram</option>
                        <option value="caixa">Caixa</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="saleAttendantFilter">Atendente</label>
                    <select id="saleAttendantFilter">
                        <option value="all" selected>Todos</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button class="clear-btn" id="clearSaleFilters">Limpar Filtros</button>
                    <button class="apply-btn" id="applySaleFilters">Aplicar Filtros</button>
                    <button class="export-btn" id="exportSaleData">Exportar Dados</button>
                </div>
            </div>
            
            <h2>Vendas</h2>
            <table>
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Cliente</th>
                        <th>Atendente</th>
                        <th>Setor</th>
                        <th>Valor</th>
                        <th>Forma de Pagamento</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="salesTable">
                    <tr>
                        <td colspan="7" style="text-align: center;">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="tab-content" id="attendants-tab">
            <div class="filters">
                <div class="filter-group">
                    <label for="attendantPeriodFilter">Período</label>
                    <select id="attendantPeriodFilter">
                        <option value="today">Hoje</option>
                        <option value="yesterday">Ontem</option>
                        <option value="week">Últimos 7 dias</option>
                        <option value="month">Últimos 30 dias</option>
                        <option value="all" selected>Todos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="attendantSectorFilter">Setor</label>
                    <select id="attendantSectorFilter">
                        <option value="all" selected>Todos</option>
                        <option value="loja_fisica">Loja Física</option>
                        <option value="whatsapp_instagram">WhatsApp/Instagram</option>
                        <option value="caixa">Caixa</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button class="clear-btn" id="clearAttendantFilters">Limpar Filtros</button>
                    <button class="apply-btn" id="applyAttendantFilters">Aplicar Filtros</button>
                    <button class="export-btn" id="exportAttendantData">Exportar Dados</button>
                </div>
            </div>
            
            <h2>Atendentes</h2>
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Setor</th>
                        <th>Atendimentos</th>
                        <th>Vendas</th>
                        <th>Valor Total</th>
                        <th>Ticket Médio</th>
                        <th>Taxa de Conversão</th>
                    </tr>
                </thead>
                <tbody id="attendantsTable">
                    <tr>
                        <td colspan="7" style="text-align: center;">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Detalhes do Atendimento</h2>
            <div id="detailsContent"></div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Configuração do Firebase -->
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBP7vj2eaIt5t49PIWRxfGXOVehkNIbJk",
            authDomain: "controle-loja-9c606.firebaseapp.com",
            projectId: "controle-loja-9c606",
            storageBucket: "controle-loja-9c606.firebasestorage.app",
            messagingSenderId: "291893265962",
            appId: "1:291893265962:web:3d2405ada39406df40a553",
            databaseURL: "https://controle-loja-9c606-default-rtdb.firebaseio.com"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
    
    <script>
        // Variáveis globais
        let allData = [];
        let filteredData = [];
        let attendants = new Set();
        
        // Elementos DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const modal = document.getElementById('detailsModal');
        const closeModal = document.querySelector('.close');
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar dados
            loadData();
            
            // Tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remover classe active de todas as tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Adicionar classe active à tab clicada
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Filtros
            document.getElementById('clearFilters').addEventListener('click', clearFilters);
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('exportData').addEventListener('click', exportData);
            
            document.getElementById('clearClientFilters').addEventListener('click', clearClientFilters);
            document.getElementById('applyClientFilters').addEventListener('click', applyClientFilters);
            document.getElementById('exportClientData').addEventListener('click', exportClientData);
            
            document.getElementById('clearSaleFilters').addEventListener('click', clearSaleFilters);
            document.getElementById('applySaleFilters').addEventListener('click', applySaleFilters);
            document.getElementById('exportSaleData').addEventListener('click', exportSaleData);
            
            document.getElementById('clearAttendantFilters').addEventListener('click', clearAttendantFilters);
            document.getElementById('applyAttendantFilters').addEventListener('click', applyAttendantFilters);
            document.getElementById('exportAttendantData').addEventListener('click', exportAttendantData);
            
            // Modal
            closeModal.addEventListener('click', function() {
                modal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        // Função para mostrar detalhes do atendimento
        function showDetails(id) {
            const item = allData.find(item => item.id === id);
            
            if (!item) {
                alert('Detalhes não encontrados');
                return;
            }
            
            let html = '';
            
            // Informações comuns
            html += createDetailRow('Data/Hora', formatDateTime(item.timestamp));
            html += createDetailRow('Cliente', item.clientName || 'Não informado');
            html += createDetailRow('Atendente', item.attendantName || 'Não informado');
            html += createDetailRow('Setor', getSectorName(item.sector));
            
            // Informações específicas por setor
            if (item.sector === 'loja_fisica') {
                html += createDetailRow('Tipo de Atendimento', item.attendanceTypeName || 'Não informado');
                if (item.attendanceType === 'sale_completed') {
                    html += createDetailRow('Valor da Venda', formatCurrency(item.saleValue));
                    html += createDetailRow('Forma de Pagamento', item.paymentMethodName || 'Não informado');
                    html += createDetailRow('Produtos Adquiridos', item.productsAcquired || 'Não informado');
                }
                html += createDetailRow('Observações', item.observations || 'Nenhuma observação');
            } else if (item.sector === 'whatsapp_instagram') {
                html += createDetailRow('Plataforma', item.platformName || 'Não informado');
                html += createDetailRow('Tipo de Interação', item.interactionTypeName || 'Não informado');
                if (item.interactionType === 'purchase') {
                    html += createDetailRow('Valor da Venda', formatCurrency(item.saleValue));
                    html += createDetailRow('Forma de Pagamento', item.paymentMethodName || 'Não informado');
                    html += createDetailRow('Produtos Adquiridos', item.productsAcquired || 'Não informado');
                }
                html += createDetailRow('Observações', item.observations || 'Nenhuma observação');
            } else if (item.sector === 'caixa') {
                html += createDetailRow('Tipo de Operação', item.operationTypeName || 'Não informado');
                if (item.operationType === 'payment' || item.operationType === 'exchange') {
                    html += createDetailRow('Valor Total', formatCurrency(item.totalValue));
                    html += createDetailRow('Forma de Pagamento', item.paymentMethodName || 'Não informado');
                    html += createDetailRow('Parcelas', item.installments || 'Não informado');
                }
                html += createDetailRow('Produtos Adquiridos', item.productsAcquired || 'Não informado');
                html += createDetailRow('Observações', item.observations || 'Nenhuma observação');
            }
            
            document.getElementById('detailsContent').innerHTML = html;
            modal.style.display = 'block';
        }
        
        // Função para criar linha de detalhe
        function createDetailRow(label, value) {
            return `
                <div class="detail-row">
                    <div class="detail-label">${label}:</div>
                    <div class="detail-value">${value}</div>
                </div>
            `;
        }
        
        // Função para formatar data e hora
        function formatDateTime(timestamp) {
            if (!timestamp) return 'Data não disponível';
            
            const date = new Date(timestamp);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Função para formatar valores monetários
        function formatCurrency(value) {
            if (!value) return 'R$ 0,00';
            
            const numValue = parseFloat(value);
            return numValue.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }
        
        // Função para obter o nome do setor
        function getSectorName(sector) {
            const sectors = {
                'loja_fisica': 'Loja Física',
                'whatsapp_instagram': 'WhatsApp/Instagram',
                'caixa': 'Caixa'
            };
            
            return sectors[sector] || sector;
        }
        
        // Função para carregar dados do Firebase
        function loadData() {
            database.ref('clientData').once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Converter objeto em array
                        const dataArray = Object.entries(data).map(([key, value]) => ({
                            id: key,
                            ...value
                        }));
                        
                        // Ordenar por data (mais recente primeiro)
                        dataArray.sort((a, b) => {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        });
                        
                        // Salvar dados
                        allData = dataArray;
                        filteredData = dataArray;
                        
                        // Coletar atendentes
                        dataArray.forEach(item => {
                            if (item.attendantName) {
                                attendants.add(item.attendantName);
                            }
                        });
                        
                        // Preencher selects de atendentes
                        fillAttendantSelects();
                        
                        // Atualizar estatísticas
                        updateStatistics(dataArray);
                        
                        // Preencher tabelas
                        fillRecentAttendancesTable(dataArray);
                        fillClientsTable(dataArray);
                        fillSalesTable(dataArray);
                        fillAttendantsTable(dataArray);
                    } else {
                        // Sem dados
                        document.getElementById('recentAttendancesTable').innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum dado encontrado</td></tr>';
                        document.getElementById('clientsTable').innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum dado encontrado</td></tr>';
                        document.getElementById('salesTable').innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum dado encontrado</td></tr>';
                        document.getElementById('attendantsTable').innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum dado encontrado</td></tr>';
                    }
                })
                .catch((error) => {
                    console.error('Erro ao carregar dados:', error);
                    alert('Erro ao carregar dados do Firebase.');
                });
        }
        
        // Função para preencher selects de atendentes
        function fillAttendantSelects() {
            const attendantSelects = [
                document.getElementById('attendantFilter'),
                document.getElementById('saleAttendantFilter')
            ];
            
            attendantSelects.forEach(select => {
                // Limpar opções existentes, exceto a primeira (Todos)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Adicionar atendentes
                attendants.forEach(attendant => {
                    const option = document.createElement('option');
                    option.value = attendant;
                    option.textContent = attendant;
                    select.appendChild(option);
                });
            });
        }
        
        // Função para atualizar estatísticas
        function updateStatistics(dataArray) {
            // Total de clientes únicos
            const uniqueClients = new Set();
            dataArray.forEach(item => {
                if (item.clientName) {
                    uniqueClients.add(item.clientName.toLowerCase());
                }
            });
            document.getElementById('totalClients').textContent = uniqueClients.size;
            
            // Total de vendas
            const sales = dataArray.filter(item => 
                (item.sector === 'loja_fisica' && item.attendanceType === 'sale_completed') || 
                (item.sector === 'whatsapp_instagram' && item.interactionType === 'purchase') ||
                (item.sector === 'caixa' && item.operationType === 'payment')
            );
            document.getElementById('totalSales').textContent = sales.length;
            
            // Valor total
            let totalValue = 0;
            sales.forEach(item => {
                if (item.sector === 'loja_fisica') {
                    totalValue += parseFloat(item.saleValue || 0);
                } else if (item.sector === 'whatsapp_instagram') {
                    totalValue += parseFloat(item.saleValue || 0);
                } else if (item.sector === 'caixa') {
                    totalValue += parseFloat(item.totalValue || 0);
                }
            });
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            
            // Ticket médio
            const averageTicket = sales.length > 0 ? totalValue / sales.length : 0;
            document.getElementById('averageTicket').textContent = formatCurrency(averageTicket);
        }
        
        // Função para preencher a tabela de atendimentos recentes
        function fillRecentAttendancesTable(dataArray) {
            let html = '';
            
            dataArray.slice(0, 20).forEach(item => {
                let type = '';
                let value = '';
                
                if (item.sector === 'loja_fisica') {
                    type = item.attendanceTypeName || '';
                    value = item.attendanceType === 'sale_completed' ? formatCurrency(item.saleValue) : '';
                } else if (item.sector === 'whatsapp_instagram') {
                    type = item.interactionTypeName || '';
                    value = item.interactionType === 'purchase' ? formatCurrency(item.saleValue) : '';
                } else if (item.sector === 'caixa') {
                    type = item.operationTypeName || '';
                    value = item.operationType === 'payment' || item.operationType === 'exchange' ? formatCurrency(item.totalValue) : '';
                }
                
                html += `
                    <tr>
                        <td>${formatDateTime(item.timestamp)}</td>
                        <td>${item.clientName || 'Não informado'}</td>
                        <td>${item.attendantName || 'Não informado'}</td>
                        <td>${getSectorName(item.sector)}</td>
                        <td>${type}</td>
                        <td>${value}</td>
                        <td><button class="view-details-btn" onclick="showDetails('${item.id}')">Ver Detalhes</button></td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" style="text-align: center;">Nenhum atendimento recente</td></tr>';
            }
            
            document.getElementById('recentAttendancesTable').innerHTML = html;
        }
        
        // Função para preencher a tabela de clientes
        function fillClientsTable(dataArray) {
            // Agrupar por cliente
            const clientsMap = new Map();
            
            dataArray.forEach(item => {
                if (!item.clientName) return;
                
                const clientName = item.clientName.toLowerCase();
                
                if (!clientsMap.has(clientName)) {
                    clientsMap.set(clientName, {
                        name: item.clientName,
                        contact: item.clientContact || '',
                        attendances: 0,
                        purchases: 0,
                        totalValue: 0,
                        lastAttendance: item.timestamp,
                        records: []
                    });
                }
                
                const client = clientsMap.get(clientName);
                client.attendances++;
                client.records.push(item);
                
                // Atualizar última data de atendimento
                if (new Date(item.timestamp) > new Date(client.lastAttendance)) {
                    client.lastAttendance = item.timestamp;
                }
                
                // Verificar se é uma compra
                let isPurchase = false;
                let purchaseValue = 0;
                
                if (item.sector === 'loja_fisica' && item.attendanceType === 'sale_completed') {
                    isPurchase = true;
                    purchaseValue = parseFloat(item.saleValue || 0);
                } else if (item.sector === 'whatsapp_instagram' && item.interactionType === 'purchase') {
                    isPurchase = true;
                    purchaseValue = parseFloat(item.saleValue || 0);
                } else if (item.sector === 'caixa' && item.operationType === 'payment') {
                    isPurchase = true;
                    purchaseValue = parseFloat(item.totalValue || 0);
                }
                
                if (isPurchase) {
                    client.purchases++;
                    client.totalValue += purchaseValue;
                }
            });
            
            // Converter para array e ordenar por número de atendimentos (decrescente)
            const clientsArray = Array.from(clientsMap.values()).sort((a, b) => b.attendances - a.attendances);
            
            let html = '';
            
            clientsArray.forEach(client => {
                html += `
                    <tr>
                        <td>${client.name}</td>
                        <td>${client.contact}</td>
                        <td>${client.attendances}</td>
                        <td>${client.purchases}</td>
                        <td>${formatCurrency(client.totalValue)}</td>
                        <td>${formatDateTime(client.lastAttendance)}</td>
                        <td><button class="view-details-btn" onclick="showClientDetails('${client.name}')">Ver Detalhes</button></td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" style="text-align: center;">Nenhum cliente encontrado</td></tr>';
            }
            
            document.getElementById('clientsTable').innerHTML = html;
        }
        
        // Função para preencher a tabela de vendas
        function fillSalesTable(dataArray) {
            // Filtrar apenas vendas
            const sales = dataArray.filter(item => 
                (item.sector === 'loja_fisica' && item.attendanceType === 'sale_completed') || 
                (item.sector === 'whatsapp_instagram' && item.interactionType === 'purchase') ||
                (item.sector === 'caixa' && item.operationType === 'payment')
            );
            
            let html = '';
            
            sales.forEach(item => {
                let value = '';
                let paymentMethod = '';
                
                if (item.sector === 'loja_fisica') {
                    value = formatCurrency(item.saleValue);
                    paymentMethod = item.paymentMethodName || 'Não informado';
                } else if (item.sector === 'whatsapp_instagram') {
                    value = formatCurrency(item.saleValue);
                    paymentMethod = item.paymentMethodName || 'Não informado';
                } else if (item.sector === 'caixa') {
                    value = formatCurrency(item.totalValue);
                    paymentMethod = item.paymentMethodName || 'Não informado';
                }
                
                html += `
                    <tr>
                        <td>${formatDateTime(item.timestamp)}</td>
                        <td>${item.clientName || 'Não informado'}</td>
                        <td>${item.attendantName || 'Não informado'}</td>
                        <td>${getSectorName(item.sector)}</td>
                        <td>${value}</td>
                        <td>${paymentMethod}</td>
                        <td><button class="view-details-btn" onclick="showDetails('${item.id}')">Ver Detalhes</button></td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" style="text-align: center;">Nenhuma venda encontrada</td></tr>';
            }
            
            document.getElementById('salesTable').innerHTML = html;
        }
        
        // Função para preencher a tabela de atendentes
        function fillAttendantsTable(dataArray) {
            // Agrupar por atendente
            const attendantsMap = new Map();
            
            dataArray.forEach(item => {
                if (!item.attendantName) return;
                
                const attendantName = item.attendantName;
                const sector = item.sector;
                
                const key = `${attendantName}-${sector}`;
                
                if (!attendantsMap.has(key)) {
                    attendantsMap.set(key, {
                        name: attendantName,
                        sector: sector,
                        attendances: 0,
                        sales: 0,
                        totalValue: 0
                    });
                }
                
                const attendant = attendantsMap.get(key);
                attendant.attendances++;
                
                // Verificar se é uma venda
                let isSale = false;
                let saleValue = 0;
                
                if (sector === 'loja_fisica' && item.attendanceType === 'sale_completed') {
                    isSale = true;
                    saleValue = parseFloat(item.saleValue || 0);
                } else if (sector === 'whatsapp_instagram' && item.interactionType === 'purchase') {
                    isSale = true;
                    saleValue = parseFloat(item.saleValue || 0);
                } else if (sector === 'caixa' && item.operationType === 'payment') {
                    isSale = true;
                    saleValue = parseFloat(item.totalValue || 0);
                }
                
                if (isSale) {
                    attendant.sales++;
                    attendant.totalValue += saleValue;
                }
            });
            
            // Converter para array e ordenar por número de vendas (decrescente)
            const attendantsArray = Array.from(attendantsMap.values()).sort((a, b) => b.sales - a.sales);
            
            let html = '';
            
            attendantsArray.forEach(attendant => {
                const ticketMedio = attendant.sales > 0 ? attendant.totalValue / attendant.sales : 0;
                const taxaConversao = attendant.attendances > 0 ? (attendant.sales / attendant.attendances) * 100 : 0;
                
                html += `
                    <tr>
                        <td>${attendant.name}</td>
                        <td>${getSectorName(attendant.sector)}</td>
                        <td>${attendant.attendances}</td>
                        <td>${attendant.sales}</td>
                        <td>${formatCurrency(attendant.totalValue)}</td>
                        <td>${formatCurrency(ticketMedio)}</td>
                        <td>${taxaConversao.toFixed(2)}%</td>
                    </tr>
                `;
            });
            
            if (html === '') {
                html = '<tr><td colspan="7" style="text-align: center;">Nenhum atendente encontrado</td></tr>';
            }
            
            document.getElementById('attendantsTable').innerHTML = html;
        }
        
        // Função para mostrar detalhes do cliente
        function showClientDetails(clientName) {
            const clientRecords = allData.filter(item => 
                item.clientName && item.clientName.toLowerCase() === clientName.toLowerCase()
            );
            
            if (clientRecords.length === 0) {
                alert('Detalhes não encontrados');
                return;
            }
            
            let html = `<h3>Histórico de Atendimentos - ${clientName}</h3>`;
            
            // Ordenar por data (mais recente primeiro)
            clientRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            clientRecords.forEach(item => {
                let type = '';
                let value = '';
                
                if (item.sector === 'loja_fisica') {
                    type = item.attendanceTypeName || '';
                    value = item.attendanceType === 'sale_completed' ? formatCurrency(item.saleValue) : '';
                } else if (item.sector === 'whatsapp_instagram') {
                    type = item.interactionTypeName || '';
                    value = item.interactionType === 'purchase' ? formatCurrency(item.saleValue) : '';
                } else if (item.sector === 'caixa') {
                    type = item.operationTypeName || '';
                    value = item.operationType === 'payment' || item.operationType === 'exchange' ? formatCurrency(item.totalValue) : '';
                }
                
                html += `
                    <div class="detail-row">
                        <div class="detail-label">${formatDateTime(item.timestamp)}</div>
                        <div class="detail-value">
                            <strong>${getSectorName(item.sector)}</strong> - ${type}
                            ${value ? ` - ${value}` : ''}
                            <button class="view-details-btn" onclick="showDetails('${item.id}')">Ver Detalhes</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('detailsContent').innerHTML = html;
            modal.style.display = 'block';
        }
        
        // Funções de filtro
        function applyFilters() {
            const period = document.getElementById('periodFilter').value;
            const sector = document.getElementById('sectorFilter').value;
            const attendant = document.getElementById('attendantFilter').value;
            
            filteredData = filterData(allData, period, sector, attendant);
            fillRecentAttendancesTable(filteredData);
        }
        
        function clearFilters() {
            document.getElementById('periodFilter').value = 'today';
            document.getElementById('sectorFilter').value = 'all';
            document.getElementById('attendantFilter').value = 'all';
            
            filteredData = allData;
            fillRecentAttendancesTable(filteredData);
        }
        
        function applyClientFilters() {
            const period = document.getElementById('clientPeriodFilter').value;
            const sector = document.getElementById('clientSectorFilter').value;
            const search = document.getElementById('clientSearchFilter').value.toLowerCase();
            
            let filtered = filterData(allData, period, sector, 'all');
            
            if (search) {
                filtered = filtered.filter(item => 
                    item.clientName && item.clientName.toLowerCase().includes(search)
                );
            }
            
            fillClientsTable(filtered);
        }
        
        function clearClientFilters() {
            document.getElementById('clientPeriodFilter').value = 'all';
            document.getElementById('clientSectorFilter').value = 'all';
            document.getElementById('clientSearchFilter').value = '';
            
            fillClientsTable(allData);
        }
        
        function applySaleFilters() {
            const period = document.getElementById('salePeriodFilter').value;
            const sector = document.getElementById('saleSectorFilter').value;
            const attendant = document.getElementById('saleAttendantFilter').value;
            
            const filtered = filterData(allData, period, sector, attendant);
            fillSalesTable(filtered);
        }
        
        function clearSaleFilters() {
            document.getElementById('salePeriodFilter').value = 'all';
            document.getElementById('saleSectorFilter').value = 'all';
            document.getElementById('saleAttendantFilter').value = 'all';
            
            fillSalesTable(allData);
        }
        
        function applyAttendantFilters() {
            const period = document.getElementById('attendantPeriodFilter').value;
            const sector = document.getElementById('attendantSectorFilter').value;
            
            const filtered = filterData(allData, period, sector, 'all');
            fillAttendantsTable(filtered);
        }
        
        function clearAttendantFilters() {
            document.getElementById('attendantPeriodFilter').value = 'all';
            document.getElementById('attendantSectorFilter').value = 'all';
            
            fillAttendantsTable(allData);
        }
        
        // Função para filtrar dados
        function filterData(data, period, sector, attendant) {
            let filtered = [...data];
            
            // Filtrar por período
            if (period !== 'all') {
                const now = new Date();
                let startDate;
                
                switch (period) {
                    case 'today':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        break;
                    case 'yesterday':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                        const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        filtered = filtered.filter(item => {
                            const date = new Date(item.timestamp);
                            return date >= startDate && date < endDate;
                        });
                        break;
                    case 'week':
                        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                        break;
                }
                
                if (period !== 'yesterday') {
                    filtered = filtered.filter(item => {
                        const date = new Date(item.timestamp);
                        return date >= startDate;
                    });
                }
            }
            
            // Filtrar por setor
            if (sector !== 'all') {
                filtered = filtered.filter(item => item.sector === sector);
            }
            
            // Filtrar por atendente
            if (attendant !== 'all') {
                filtered = filtered.filter(item => item.attendantName === attendant);
            }
            
            return filtered;
        }
        
        // Funções de exportação
        function exportData() {
            exportToCSV(filteredData, 'atendimentos');
        }
        
        function exportClientData() {
            // Agrupar por cliente
            const clientsMap = new Map();
            
            const filtered = filterData(
                allData,
                document.getElementById('clientPeriodFilter').value,
                document.getElementById('clientSectorFilter').value,
                'all'
            );
            
            const search = document.getElementById('clientSearchFilter').value.toLowerCase();
            
            let dataToExport = filtered;
            if (search) {
                dataToExport = filtered.filter(item => 
                    item.clientName && item.clientName.toLowerCase().includes(search)
                );
            }
            
            dataToExport.forEach(item => {
                if (!item.clientName) return;
                
                const clientName = item.clientName.toLowerCase();
                
                if (!clientsMap.has(clientName)) {
                    clientsMap.set(clientName, {
                        name: item.clientName,
                        contact: item.clientContact || '',
                        attendances: 0,
                        purchases: 0,
                        totalValue: 0,
                        lastAttendance: item.timestamp
                    });
                }
                
                const client = clientsMap.get(clientName);
                client.attendances++;
                
                // Atualizar última data de atendimento
                if (new Date(item.timestamp) > new Date(client.lastAttendance)) {
                    client.lastAttendance = item.timestamp;
                }
                
                // Verificar se é uma compra
                let isPurchase = false;
                let purchaseValue = 0;
                
                if (item.sector === 'loja_fisica' && item.attendanceType === 'sale_completed') {
                    isPurchase = true;
                    purchaseValue = parseFloat(item.saleValue || 0);
                } else if (item.sector === 'whatsapp_instagram' && item.interactionType === 'purchase') {
                    isPurchase = true;
                    purchaseValue = parseFloat(item.saleValue || 0);
                } else if (item.sector === 'caixa' && item.operationType === 'payment') {
                    isPurchase = true;
                    purchaseValue = parseFloat(item.totalValue || 0);
                }
                
                if (isPurchase) {
                    client.purchases++;
                    client.totalValue += purchaseValue;
                }
            });
            
            // Converter para array
            const clientsArray = Array.from(clientsMap.values());
            
            // Preparar dados para CSV
            const csvData = clientsArray.map(client => ({
                'Nome': client.name,
                'Contato': client.contact,
                'Atendimentos': client.attendances,
                'Compras': client.purchases,
                'Valor Total': client.totalValue.toFixed(2),
                'Último Atendimento': formatDateTime(client.lastAttendance)
            }));
            
            downloadCSV(csvData, 'clientes');
        }
        
        function exportSaleData() {
            // Filtrar apenas vendas
            const filtered = filterData(
                allData,
                document.getElementById('salePeriodFilter').value,
                document.getElementById('saleSectorFilter').value,
                document.getElementById('saleAttendantFilter').value
            );
            
            const sales = filtered.filter(item => 
                (item.sector === 'loja_fisica' && item.attendanceType === 'sale_completed') || 
                (item.sector === 'whatsapp_instagram' && item.interactionType === 'purchase') ||
                (item.sector === 'caixa' && item.operationType === 'payment')
            );
            
            // Preparar dados para CSV
            const csvData = sales.map(item => {
                let value = 0;
                let paymentMethod = '';
                
                if (item.sector === 'loja_fisica') {
                    value = parseFloat(item.saleValue || 0);
                    paymentMethod = item.paymentMethodName || 'Não informado';
                } else if (item.sector === 'whatsapp_instagram') {
                    value = parseFloat(item.saleValue || 0);
                    paymentMethod = item.paymentMethodName || 'Não informado';
                } else if (item.sector === 'caixa') {
                    value = parseFloat(item.totalValue || 0);
                    paymentMethod = item.paymentMethodName || 'Não informado';
                }
                
                return {
                    'Data/Hora': formatDateTime(item.timestamp),
                    'Cliente': item.clientName || 'Não informado',
                    'Atendente': item.attendantName || 'Não informado',
                    'Setor': getSectorName(item.sector),
                    'Valor': value.toFixed(2),
                    'Forma de Pagamento': paymentMethod
                };
            });
            
            downloadCSV(csvData, 'vendas');
        }
        
        function exportAttendantData() {
            // Agrupar por atendente
            const attendantsMap = new Map();
            
            const filtered = filterData(
                allData,
                document.getElementById('attendantPeriodFilter').value,
                document.getElementById('attendantSectorFilter').value,
                'all'
            );
            
            filtered.forEach(item => {
                if (!item.attendantName) return;
                
                const attendantName = item.attendantName;
                const sector = item.sector;
                
                const key = `${attendantName}-${sector}`;
                
                if (!attendantsMap.has(key)) {
                    attendantsMap.set(key, {
                        name: attendantName,
                        sector: sector,
                        attendances: 0,
                        sales: 0,
                        totalValue: 0
                    });
                }
                
                const attendant = attendantsMap.get(key);
                attendant.attendances++;
                
                // Verificar se é uma venda
                let isSale = false;
                let saleValue = 0;
                
                if (sector === 'loja_fisica' && item.attendanceType === 'sale_completed') {
                    isSale = true;
                    saleValue = parseFloat(item.saleValue || 0);
                } else if (sector === 'whatsapp_instagram' && item.interactionType === 'purchase') {
                    isSale = true;
                    saleValue = parseFloat(item.saleValue || 0);
                } else if (sector === 'caixa' && item.operationType === 'payment') {
                    isSale = true;
                    saleValue = parseFloat(item.totalValue || 0);
                }
                
                if (isSale) {
                    attendant.sales++;
                    attendant.totalValue += saleValue;
                }
            });
            
            // Converter para array
            const attendantsArray = Array.from(attendantsMap.values());
            
            // Preparar dados para CSV
            const csvData = attendantsArray.map(attendant => {
                const ticketMedio = attendant.sales > 0 ? attendant.totalValue / attendant.sales : 0;
                const taxaConversao = attendant.attendances > 0 ? (attendant.sales / attendant.attendances) * 100 : 0;
                
                return {
                    'Nome': attendant.name,
                    'Setor': getSectorName(attendant.sector),
                    'Atendimentos': attendant.attendances,
                    'Vendas': attendant.sales,
                    'Valor Total': attendant.totalValue.toFixed(2),
                    'Ticket Médio': ticketMedio.toFixed(2),
                    'Taxa de Conversão': taxaConversao.toFixed(2) + '%'
                };
            });
            
            downloadCSV(csvData, 'atendentes');
        }
        
        // Função para exportar para CSV
        function exportToCSV(data, filename) {
            // Preparar dados para CSV
            const csvData = data.map(item => {
                let type = '';
                let value = '';
                
                if (item.sector === 'loja_fisica') {
                    type = item.attendanceTypeName || '';
                    value = item.attendanceType === 'sale_completed' ? parseFloat(item.saleValue || 0) : 0;
                } else if (item.sector === 'whatsapp_instagram') {
                    type = item.interactionTypeName || '';
                    value = item.interactionType === 'purchase' ? parseFloat(item.saleValue || 0) : 0;
                } else if (item.sector === 'caixa') {
                    type = item.operationTypeName || '';
                    value = item.operationType === 'payment' || item.operationType === 'exchange' ? parseFloat(item.totalValue || 0) : 0;
                }
                
                return {
                    'Data/Hora': formatDateTime(item.timestamp),
                    'Cliente': item.clientName || 'Não informado',
                    'Atendente': item.attendantName || 'Não informado',
                    'Setor': getSectorName(item.sector),
                    'Tipo': type,
                    'Valor': value.toFixed(2)
                };
            });
            
            downloadCSV(csvData, filename);
        }
        
        // Função para download de CSV
        function downloadCSV(data, filename) {
            if (data.length === 0) {
                alert('Nenhum dado para exportar');
                return;
            }
            
            // Obter cabeçalhos
            const headers = Object.keys(data[0]);
            
            // Criar conteúdo CSV
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = headers.map(header => {
                    // Escapar aspas e adicionar aspas ao redor de campos com vírgulas
                    const value = item[header].toString().replace(/"/g, '""');
                    return value.includes(',') ? `"${value}"` : value;
                });
                
                csvContent += row.join(',') + '\n';
            });
            
            // Criar blob e link para download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
